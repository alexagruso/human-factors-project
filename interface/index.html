<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ExpenseAid</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="default.css">
</head>

<body>
  <header>
    <div class="header">
      <a class="logo"><img src="https://fakeimg.pl/600x400/50597b/ffffff?text=ExpenseAid&font=bebas"
          style="width: 50px; height: 50px;"> ExpenseAid</a>
      <div class="header-right">
        <a class="active" href="#home" onclick="myFunction()">&#9728;</a>
        <a href="profile.html" class="active" style="padding: 12px;">Profile</a>
      </div>
    </div>
  </header>

  <div class="introduction">
    <br>
    <h1>Snap & Save: Budgeting Made Easy!</h1>
    <h2>Scan, or Upload Your Receipts Today!</h2>
    <button onclick="showUploadOptions()">Scan or Upload Receipts</button>
    <br>
    <div class="upload-options-container" id="uploadOptionsContainer" style="display: none;">
      <div class="form-container">
        <form is="uploadForm">
          <input type="file" id="receiptImage" accept="image/*"><br>
          <button type="button" onclick="encodeImage()">Upload Receipt</button>
        </form>
      </div>
      <br>
      <br>
      <div class="form-container">
        <button onclick="openReceiptForm()" style="padding: 15px 40px;">Enter Receipt Details Manually</button>
      </div>
      <br>
      <div class="form-container" id="manualEntryForm" style="display: none;">
        <div class="manual-entry-card">
          <form onsubmit="submitManualEntry(event)">
            <label for="merchantName">Merchant Name:</label>
            <input type="text" id="merchantName" name="merchantName" placeholder="Merchant Name...">

            <label for="transactionDate">Transaction Date:</label>
            <input type="date" id="transactionDate" name="transactionDate"><br>

            <br>
            <div id="itemFieldsContainer">
              <div class="item-field">
                <select class="itemType">
                  <option value="Food">Food</option>
                  <option value="Automotive">Automotive</option>
                  <option value="Personal Care">Personal Care</option>
                  <option value="Merchandise">Merchandise</option>
                  <option value="Clothes">Clothes</option>
                  <option value="Miscellaneous">Miscellaneous</option>
                </select>
                <input type="text" class="itemName" name="itemName" placeholder="Item Name...">
                <input type="number" class="quantity" name="quantity" placeholder="Qty." style="width: 3.5em;">
                <input type="text" class="price" name="price" placeholder="Price">
                <button name="deleteButton" onclick="deleteNode(this)">X</button>
              </div>
            </div>
            <br>

            <button type="button" onclick="addNewItemField()">Add More Items</button>

            <label for="totalCost">Total Cost:</label>
            <input type="number" id="totalCost" name="totalCost" placeholder="Total Cost.." readonly>

            <input type="submit" value="Submit">
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="banner">
    <h1>&#x2606;</h1>
  </div>

  <div class="info">
    <img src="https://fakeimg.pl/600x400/50597b/ffffff?text=ExpenseAid&font=bebas" alt="logo"
      style="width: 350px; height: 350px; float: left; margin-right: 10px;">
    <h3>WHAT DO WE PUT HERE? (SMILEY FACE)</h3>
    <p>&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;</p>
    <p>(can and will def change the picture it's just there for now)</p>
    <p>&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;&#x2606;</p>
    <h6>we'll figure this out :P</h6>
  </div>

  <footer>
    Made with &#10084; by Luke, Alex, and Aliyah
  </footer>

  <script>
    function myFunction() {
      var element = document.body;
      element.classList.toggle("light-mode");
      var manualEntryCard = document.querySelector(".manual-entry-card");
      var banner = document.querySelector(".banner");
      var footer = document.querySelector("footer");
      var header = document.querySelector(".header");

      if (element.classList.contains("light-mode")) {
        manualEntryCard.style.backgroundColor = "#1f253d";
        banner.style.backgroundColor = "#1f253d";
        footer.style.backgroundColor = "#1f253d";
        header.style.backgroundColor = "#1f253d";
      } else {
        manualEntryCard.style.backgroundColor = "#50597b"; // Change to the dark mode color
        banner.style.backgroundColor = "#50597b";
        footer.style.backgroundColor = "#50597b";
        header.style.backgroundColor = "#50597b";
      }
    }

    function showUploadOptions() {
      const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
      uploadOptionsContainer.style.display = "block";

      // Hide the "Scan or Upload Receipts" button
      const scanUploadButton = document.querySelector(".introduction button");
      scanUploadButton.style.display = "none";
    }

    async function encodeImage() {
      const fileInput = document.getElementById('receiptImage');
      const file = fileInput.files[0];
      const reader = new FileReader();


      reader.onload = function (event) {
        const base64String = event.target.result.split(',')[1]; // Extract base64 data
        submitReceipt(base64String);
      };


      reader.readAsDataURL(file);
    }

    function openReceiptForm() {
      document.getElementById("manualEntryForm").style.display = "block";
    }

    async function submitManualEntry(event) {
      event.preventDefault();

      const merchantName = document.getElementById('merchantName').value;
      const transactionDate = document.getElementById('transactionDate').value;


      const itemData = [];
      const itemFields = document.querySelectorAll('.item-field');
      itemFields.forEach((itemField, index) => {
        const itemType = itemField.querySelector('.itemType').value;
        const itemName = itemField.querySelector('.itemName').value;
        const quantity = itemField.querySelector('.quantity').value;
        const price = itemField.querySelector('.price').value;
        itemData.push({itemType, itemName, quantity, price});
      });


      const manualEntryData = {
        merchantName,
        transactionDate,
        items: itemData
      };


      try {
        const response = await fetch('/api/manualEntry', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(manualEntryData)
        });
        const data = await response.json();
        console.log('Manual entry data saved:', data);
        // Optionally, display a success message to the user
        alert('Manual entry data submitted successfully.');
      } catch (error) {
        console.error('Error submitting manual entry:', error);
        // Optionally, display an error message to the user
        alert('Error submitting manual entry. Please try again later.');
      }
    }

    let itemIndex = 1;

    function deleteNode(item) {
      item.parentNode.remove()
    }

    function addNewItemField() {
      const itemFieldsContainer = document.getElementById('itemFieldsContainer');
      const newItemField = document.createElement('div');
      newItemField.classList.add('item-field');
      newItemField.innerHTML = `
                <br><select class="itemType">
                    <option value="Food">Food</option>
                    <option value="Automotive">Automotive</option>
                    <option value="Personal Care">Personal Care</option>
                    <option value="Merchandise">Merchandise</option>
                    <option value="Clothes">Clothes</option>
                    <option value="Miscellaneous">Miscellaneous</option>
                </select>
                <input type="text" class="itemName" name="itemName" placeholder="Item Name...">
                <input type="number" class="quantity" name="quantity" placeholder="Qty." style="width: 3.5em;">
                <input type="number" step="any" class="price" name="price" placeholder="Price">
                <button name = "deleteButton" onclick="deleteNode(this)">X</button>
            `;
      itemFieldsContainer.appendChild(newItemField);
    }

    // Function to handle search
    function handleSearch() {
      const searchQuery = document.querySelector('.searchInput').value;

      fetch(`/api/search?query=${searchQuery}`)
        .then(response => response.json())
        .then(data => {
          console.log(data);
        })
        .catch(error => {
          console.error('Error searching:', error);
        });
    }

    document.querySelector('.searchInput').addEventListener('input', handleSearch);

    // Function to format and validate price inputs
    document.querySelectorAll('.price').forEach(input => {
      input.addEventListener('input', function (event) {
        let value = event.target.value;

        // Remove any non-numeric characters except for decimal point
        value = value.replace(/[^0-9.]/g, '');

        // Ensure that only one decimal point is allowed
        const decimalCount = (value.match(/\./g) || []).length;
        if (decimalCount > 1) {
          value = value.substr(0, value.lastIndexOf('.'));
        }

        // Update the input value with formatted number
        event.target.value = value;
      });
    });

    // Function to calculate total cost
    function calculateTotalCost() {
      const totalCostInput = document.getElementById('totalCost');
      const itemFields = document.querySelectorAll('.item-field');
      let total = 0;
      itemFields.forEach(itemField => {
        const priceInput = itemField.querySelector('.price').value;
        if (priceInput) {
          total += parseFloat(priceInput);
        }
      });
      totalCostInput.value = total.toFixed(2);
    }

    // Call calculateTotalCost function whenever there's a change in item price
    document.querySelectorAll('.price').forEach(input => {
      input.addEventListener('input', calculateTotalCost);
    });

    // Function to submit receipt manually
    async function submitReceipt(event) {
      event.preventDefault();

      const formData = new FormData();
      formData.append('receiptImage', document.getElementById('receiptImage').files[0]);

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();

        const receiptList = document.getElementById('receiptList');
        const listItem = document.createElement('li');
        listItem.innerHTML = `
            <p>Receipt Type: ${data.receiptType}</p>
            <p>Merchant Name: ${data.merchant_name}</p>
            <p>Transaction Date: ${data.transaction_date}</p>
            <p>Items:</p>
            <ul>
                ${data.items.map(item => `<li>Name: ${item.name}, Quantity: ${item.quantity}, Total: ${item.total_item}, Category: ${item.item_category}</li>`).join('')}
            </ul>
            <p>Grand Total: ${data.grand_total}</p>
            `;
        receiptList.appendChild(listItem);
      } catch (error) {
        console.error('Error uploading receipt:', error);
      }
    }

  </script>

  <script src="app.js"></script>

</body>

</html>